{% load static %}
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>SmartHealth - Dashboard</title>

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>

		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="{% static 'css/main.css' %}" />
	</head>

	<body
		class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 text-slate-900"
	>
		<!-- NAVBAR -->
		<nav class="sticky top-0 z-50 bg-white/90 backdrop-blur shadow">
			<div
				class="mx-auto flex max-w-6xl items-center justify-between px-5 py-4"
			>
				<div class="text-2xl font-extrabold text-indigo-700">
					ğŸ’ª SmartHealth
				</div>

				<div
					class="flex items-center gap-4 text-sm font-semibold text-slate-700"
				>
					<a
						href="{% url 'dashboard' %}"
						class="px-3 py-2 text-indigo-700 border-b-2 border-indigo-600"
						>Home</a
					>
					<a
						href="{% url 'dashboard_diet' %}"
						class="px-3 py-2 hover:text-indigo-600"
						>Diet</a
					>
					<a
						href="{% url 'dashboard_workout' %}"
						class="px-3 py-2 hover:text-indigo-600"
						>Workout</a
					>
				</div>

				<div class="flex items-center gap-3 text-sm font-medium">
					<span class="hidden sm:inline"
						>Hi, {{ user.username }}</span
					>
					<a
						href="{% url 'logout' %}"
						class="rounded-lg bg-red-500 px-4 py-2 text-white font-semibold hover:bg-red-600 transition"
					>
						Logout
					</a>
				</div>
			</div>
		</nav>

		<main class="max-w-6xl mx-auto py-12 px-4 space-y-8">
			{% if messages %}
			<div class="space-y-3">
				{% for message in messages %}
				<div
					class="flex items-start gap-3 rounded-2xl border px-5 py-4 shadow-sm {% if 'success' in message.tags %}border-green-200 bg-green-50 text-green-800{% elif 'error' in message.tags or 'danger' in message.tags %}border-red-200 bg-red-50 text-red-800{% elif 'warning' in message.tags %}border-amber-200 bg-amber-50 text-amber-800{% else %}border-indigo-200 bg-indigo-50 text-indigo-800{% endif %}"
				>
					<div
						class="flex h-8 w-8 items-center justify-center rounded-full {% if 'success' in message.tags %}bg-green-100{% elif 'error' in message.tags or 'danger' in message.tags %}bg-red-100{% elif 'warning' in message.tags %}bg-amber-100{% else %}bg-indigo-100{% endif %}"
					>
						{% if 'success' in message.tags %}
						<span class="text-lg">âœ…</span>
						{% elif 'error' in message.tags or 'danger' in message.tags %}
						<span class="text-lg">â›”</span>
						{% elif 'warning' in message.tags %}
						<span class="text-lg">âš ï¸</span>
						{% else %}
						<span class="text-lg">â„¹ï¸</span>
						{% endif %}
					</div>
					<div class="text-sm leading-relaxed">{{ message }}</div>
				</div>
				{% endfor %}
			</div>
			{% endif %}

			{% if error_message %}
			<div class="flex items-start gap-3 rounded-2xl border border-red-200 bg-red-50 px-5 py-4 text-red-800 shadow-sm">
				<div class="flex h-8 w-8 items-center justify-center rounded-full bg-red-100">
					<span class="text-lg">â›”</span>
				</div>
				<div class="text-sm leading-relaxed">{{ error_message }}</div>
			</div>
			{% endif %}

			{% if plan %}
			<script>
				// Get today's day index (0=Monday, 6=Sunday)
				const todayIndex = (new Date().getDay() + 6) % 7;
				
				// Parse JSON data from Django
				const dietPlan = {{ diet_plan_json|safe }};
				const workoutPlan = {{ workout_plan_json|safe }};
			</script>

			<!-- USER GOAL CARD -->
			<section class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white rounded-3xl shadow-2xl p-8 transform hover:shadow-3xl transition">
				<div class="flex items-start justify-between">
					<div>
						<p class="text-indigo-100 text-sm font-semibold mb-2">YOUR FITNESS GOAL</p>
						<h2 class="text-4xl font-bold mb-3">{{ profile.goal|title }}</h2>
						<p class="text-indigo-100 text-lg mb-1">Current Weight: <span class="font-bold text-2xl text-white">{{ profile.weight_kg }} kg</span></p>
						<p class="text-indigo-100 text-lg">Target Weight: <span class="font-bold text-2xl text-white">{{ profile.target_weight_kg }} kg</span></p>
					</div>
					<div class="text-6xl opacity-20">ğŸƒ</div>
				</div>
			</section>

			<!-- TODAY SUMMARY CARDS -->
			<section>
				<div class="flex items-center gap-3 mb-6">
					<h1 class="text-4xl font-bold text-slate-900">Today's Plan</h1>
					<span class="text-5xl">ğŸ“…</span>
				</div>

				<div class="grid md:grid-cols-2 gap-8">
					<!-- TODAY DIET CARD -->
					<div class="group bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition transform hover:scale-105">
						<div class="bg-gradient-to-r from-green-400 to-emerald-500 p-6 text-white">
							<div class="flex items-center justify-between">
								<div class="flex items-center gap-3">
									<span class="text-4xl">ğŸ¥—</span>
									<h3 class="text-2xl font-bold">Today's Meals</h3>
								</div>
								<div id="today-calories" class="text-white/90 text-sm font-semibold">ğŸ”¥ ...</div>
							</div>
						</div>
						<div class="p-6">
							<script>
								const todayDiet = dietPlan[todayIndex];
								
								if (todayDiet) {
									document.write(`
										<div class="flex items-center justify-between mb-3">
											<p class="text-sm font-semibold text-slate-500">${todayDiet.day}</p>
											<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold">${todayDiet.meals.length} meals</span>
										</div>
										<ul id="meals-list" class="space-y-3">
									`);
									
									todayDiet.meals.forEach((meal, idx) => {
										const mealType = meal.includes('Breakfast') ? 'ğŸŒ… Breakfast' :
														 meal.includes('Lunch') ? 'â˜€ï¸ Lunch' :
														 meal.includes('Dinner') ? 'ğŸŒ™ Dinner' :
														 meal.includes('Snack') ? 'ğŸ Snack' : 'ğŸ½ï¸ Meal';
										
										document.write(`
											<li class="meal-item border-l-3 border-emerald-200 pl-3 ${idx >= 3 ? 'hidden' : ''}">
												<div class="flex items-start justify-between gap-2 mb-1">
													<span class="text-xs font-bold text-emerald-600 uppercase">${mealType}</span>
													<span class="meal-cal px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-bold" data-meal="${meal}">0</span>
												</div>
												<p class="text-slate-700 text-sm leading-relaxed">${meal.substring(10)}</p>
											</li>
										`);
									});
									
									document.write('</ul>');
									
									if (todayDiet.meals.length > 3) {
										document.write(`
											<button onclick="toggleMeals()" id="toggle-meals-btn" class="mt-3 text-emerald-600 hover:text-emerald-700 text-sm font-semibold hover:underline cursor-pointer">
												+ ${todayDiet.meals.length - 3} more meals
											</button>
										`);
									}
								} else {
									document.write(`
										<p class="text-slate-500 italic">No meals planned for today</p>
										<form method="POST" action="{% url 'generate_diet' %}" class="inline-block">
											{% csrf_token %}
											<button class="px-10 py-4 text-center bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-105">
												Generate Diet Plan
											</button>
										</form>
									`);
								}
							</script>
							<script>
								document.addEventListener('DOMContentLoaded', function() {
					function extractCalories(text) {
						const kcalMatches = [...text.matchAll(/(\d+)\s*kcal/gi)];
						if (kcalMatches.length) {
							return kcalMatches.reduce((sum, m) => sum + parseInt(m[1]), 0);
						}
						const calMatches = [...text.matchAll(/(\d+)\s*calor(?:ies)?/gi)];
						if (calMatches.length) {
							return calMatches.reduce((sum, m) => sum + parseInt(m[1]), 0);
						}
						return null;
					}

					let total = 0;
					document.querySelectorAll('.meal-cal').forEach(function(badge) {
						const mealText = badge.getAttribute('data-meal') || '';
						const cal = extractCalories(mealText);
						if (cal !== null) {
							badge.textContent = cal + ' cal';
							total += cal;
						} else {
							badge.style.display = 'none';
						}
					});
					const totalDiv = document.getElementById('today-calories');
					if (totalDiv && total > 0) totalDiv.textContent = 'ğŸ”¥ ' + total + ' cal';
								});

								function toggleMeals() {
									const hiddenMeals = document.querySelectorAll('.meal-item.hidden');
									const btn = document.getElementById('toggle-meals-btn');
									if (hiddenMeals.length > 0) {
										hiddenMeals.forEach(meal => meal.classList.remove('hidden'));
										btn.textContent = 'âˆ’ Show less';
									} else {
										const allMeals = document.querySelectorAll('.meal-item');
										allMeals.forEach((meal, index) => {
											if (index >= 3) meal.classList.add('hidden');
										});
										btn.textContent = '+ ' + (allMeals.length - 3) + ' more meals';
									}
								}

								function toggleExercises() {
									const hiddenExercises = document.querySelectorAll('.exercise-item.hidden');
									const btn = document.getElementById('toggle-exercises-btn');
									if (hiddenExercises.length > 0) {
										hiddenExercises.forEach(ex => ex.classList.remove('hidden'));
										btn.textContent = 'âˆ’ Show less';
									} else {
										const allExercises = document.querySelectorAll('.exercise-item');
										allExercises.forEach((ex, index) => {
											if (index >= 3) ex.classList.add('hidden');
										});
										btn.textContent = '+ ' + (allExercises.length - 3) + ' more exercises';
									}
								}
							</script>
						</div>
					</div>

					<!-- TODAY WORKOUT CARD -->
					<div class="group bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition transform hover:scale-105">
						<div class="bg-gradient-to-r from-blue-400 to-cyan-500 p-6 text-white">
							<div class="flex items-center justify-between">
								<div class="flex items-center gap-3">
									<span class="text-4xl">ğŸ’ª</span>
									<div>
										<h3 class="text-2xl font-bold">Today's Workout</h3>
									</div>
								</div>
							</div>
						</div>
						<div class="p-6">
							<script>
								const todayWorkout = workoutPlan[todayIndex];
								
								if (todayWorkout) {
									document.write(`
										<div class="mb-4">
											<p class="text-sm font-semibold text-slate-500 mb-2">${todayWorkout.day}</p>
											<p class="text-lg font-bold text-slate-900 mb-3">${todayWorkout.focus}</p>
											<div class="flex gap-3 mb-4">
												<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
													â±ï¸ ${todayWorkout.duration_min} min
												</span>
												<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-semibold">
													ğŸ”¥ ${todayWorkout.calories} cal
												</span>
											</div>
										</div>
									`);
									
									if (todayWorkout.exercises && todayWorkout.exercises.length > 0) {
										document.write(`
											<div class="border-t border-slate-200 pt-4">
												<p class="text-sm font-semibold text-slate-600 mb-3">Exercises (${todayWorkout.exercises.length})</p>
												<ul id="exercises-list" class="space-y-2">
										`);
										
										todayWorkout.exercises.forEach((exercise, idx) => {
											document.write(`
												<li class="exercise-item flex gap-2 items-start text-slate-700 text-sm ${idx >= 3 ? 'hidden' : ''}">
													<span class="text-blue-500 font-bold">â†’</span>
													<span>${exercise.name}</span>
												</li>
											`);
										});
										
										document.write('</ul>');
										
										if (todayWorkout.exercises.length > 3) {
											document.write(`
												<button onclick="toggleExercises()" id="toggle-exercises-btn" class="mt-3 text-blue-600 hover:text-blue-700 text-sm font-semibold hover:underline cursor-pointer">
													+ ${todayWorkout.exercises.length - 3} more exercises
												</button>
											`);
										}
										
										document.write('</div>');
									} else {
										document.write('<p class="text-slate-500 italic text-center py-4">Rest day - No exercises scheduled</p>');
									}
								} else {
									document.write(`
										<p class="text-slate-500 italic">No workout planned for today</p>
										<form method="POST" action="{% url 'generate_workout' %}" class="inline-block">
											{% csrf_token %}
											<button class="px-10 py-4 text-center bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl hover:from-blue-600 hover:to-cyan-700 transition transform hover:scale-105">
												Generate Workout Plan
											</button>
										</form>
									`);
								}
							</script>
						</div>
					</div>
				</div>
			</section>

			{% else %}
			<!-- NO PLAN CTA -->
			<section class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl p-16 text-center">
				<div class="max-w-2xl mx-auto">
					<div class="text-7xl mb-6">ğŸš€</div>
					<h2 class="text-4xl font-bold text-slate-900 mb-4">Let's Get Started!</h2>
					<p class="text-xl text-slate-600 mb-8">
						Generate your personalized diet and workout plan based on your profile.
					</p>
					<div class="flex gap-4">
						<form method="POST" action="{% url 'generate_diet' %}" class="inline-block">
							{% csrf_token %}
							<button
								class="px-10 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-105"
							>
								Generate Diet Plan
							</button>
						</form>
						<form method="POST" action="{% url 'generate_workout' %}" class="inline-block">
							{% csrf_token %}
							<button
								class="px-10 py-4 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl hover:from-blue-600 hover:to-cyan-700 transition transform hover:scale-105"
							>
								Generate Workout Plan
							</button>
						</form>
					</div>
				</div>
			</section>
			{% endif %}
		</main>
	</body>
</html>
